<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LTC1043 Capacitive Front-End Simulator</title>
  <link rel="stylesheet" href="/src/styles.css" />
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <h1>LTC1043 Capacitive Sensor Front-End Simulator</h1>
      <p>
        Physics-based simulation for the capacitive displacement front-end from the FBV documentation.
        This models only the sensor + switched-cap stage (Ca/Cb/Cc, R10/R11, C3/C4, switching frequency).
      </p>
    </section>

    <section class="layout">
      <aside class="panel" aria-label="Inputs panel">
        <h2>Inputs</h2>

        <div class="field-grid">
          <div class="field">
            <label for="widthCm">Plate width (cm)</label>
            <input id="widthCm" type="number" step="any" min="0.001" />
          </div>

          <div class="field">
            <label for="heightCm">Plate height (cm)</label>
            <input id="heightCm" type="number" step="any" min="0.001" />
          </div>

          <div class="field wide">
            <label for="plateAreaInfo">Computed plate area (cm²)</label>
            <input id="plateAreaInfo" type="text" readonly />
          </div>

          <div class="field">
            <label for="totalGapMm">Total outer-plate separation G (mm)</label>
            <input id="totalGapMm" type="number" step="any" min="0.0001" />
          </div>

          <div class="field">
            <label for="minGapMm">Minimum gap clamp (mm)</label>
            <input id="minGapMm" type="number" step="any" min="0.00001" />
          </div>

          <div class="field wide">
            <label for="position">Position fraction p (0 left, 1 right)</label>
            <div class="range-row">
              <input id="position" type="range" min="0" max="1" step="any" />
              <input id="positionText" type="text" readonly />
            </div>
          </div>

          <div class="field wide">
            <label for="positionOffsetMm">Offset from center (mm, +right / -left)</label>
            <input id="positionOffsetMm" type="number" step="0.1" />
          </div>

          <div class="field wide">
            <label for="freqHz">Switching frequency (Hz)</label>
            <input id="freqHz" type="number" step="any" min="1" />
          </div>
        </div>

        <details open>
          <summary>Advanced Components</summary>
          <div class="field-grid" style="margin-top: 0.45rem;">
            <div class="field">
              <label for="vDrivePeakV">Drive amplitude Vpeak (V)</label>
              <input id="vDrivePeakV" type="number" step="any" min="0.01" />
            </div>

            <div class="field">
              <label for="epsilonR">Dielectric εr (air fixed)</label>
              <input id="epsilonR" type="number" readonly />
            </div>

            <div class="field">
              <label for="r10Ohm">R10 (Ω)</label>
              <input id="r10Ohm" type="number" step="any" min="1" />
            </div>

            <div class="field">
              <label for="r11Ohm">R11 (Ω)</label>
              <input id="r11Ohm" type="number" step="any" min="1" />
            </div>

            <div class="field">
              <label for="rEqOhm">R_eq (Ω, output load)</label>
              <input id="rEqOhm" type="number" step="any" min="1" />
            </div>

            <div class="field">
              <label for="c3F">C3 (pF)</label>
              <input id="c3F" type="number" step="any" min="0.001" />
            </div>

            <div class="field">
              <label for="c4F">C4 (pF)</label>
              <input id="c4F" type="number" step="any" min="0.001" />
            </div>

            <div class="field wide">
              <label for="ccF">Cc stray (pF)</label>
              <input id="ccF" type="number" step="any" min="0" />
            </div>
          </div>
        </details>

        <details>
          <summary>Sweep Controls</summary>
          <div class="field-grid" style="margin-top: 0.45rem;">
            <div class="field">
              <label for="freqMinHz">Freq min (Hz)</label>
              <input id="freqMinHz" type="number" step="any" min="1" />
            </div>
            <div class="field">
              <label for="freqMaxHz">Freq max (Hz)</label>
              <input id="freqMaxHz" type="number" step="any" min="1" />
            </div>
            <div class="field">
              <label for="freqPoints">Freq points</label>
              <input id="freqPoints" type="number" step="any" min="8" max="500" />
            </div>

            <div class="field">
              <label for="gapMinMm">Gap min (mm)</label>
              <input id="gapMinMm" type="number" step="any" min="0.0001" />
            </div>
            <div class="field">
              <label for="gapMaxMm">Gap max (mm)</label>
              <input id="gapMaxMm" type="number" step="any" min="0.0001" />
            </div>
            <div class="field">
              <label for="gapPoints">Gap points</label>
              <input id="gapPoints" type="number" step="any" min="8" max="500" />
            </div>

            <div class="field wide">
              <label for="positionPoints">Position points</label>
              <input id="positionPoints" type="number" step="any" min="8" max="500" />
            </div>
          </div>
        </details>
      </aside>

      <section style="display:grid; gap: 1rem;">
        <section class="panel" aria-label="Metrics panel">
          <h2>Simulation Metrics</h2>
          <div class="metrics-grid" id="metrics"></div>
          <div id="warnings"></div>

          <div class="validation">
            <h2 style="margin-top:0;">Validation (Reference-Only)</h2>
            <div class="row head">
              <div>Metric</div>
              <div>Computed</div>
              <div>Reference / Deviation</div>
            </div>
            <div id="validationRows"></div>
            <p style="margin:0.45rem 0 0; font-size:0.8rem; color:#5f6d7a;">
              Reference values from the PDF are displayed only for comparison and are not used in core equations.
            </p>
          </div>
        </section>

        <section class="panel charts" aria-label="Charts panel">
          <h2>Charts</h2>

          <article class="chart-card">
            <div class="chart-head">
              <p class="title">Vout vs Switching Frequency</p>
              <p class="sub">Log-frequency sweep</p>
            </div>
            <canvas id="chartFreq" width="900" height="260"></canvas>
          </article>

          <article class="chart-card">
            <div class="chart-head">
              <p class="title">Vout vs Position Fraction</p>
              <p class="sub">Centered sweep (p = 0.1 to 0.9)</p>
            </div>
            <canvas id="chartPos" width="900" height="260"></canvas>
          </article>

          <article class="chart-card">
            <div class="chart-head">
              <p class="title">Vout vs Total Separation G</p>
              <p class="sub">Gap sweep at fixed frequency and position</p>
            </div>
            <canvas id="chartGap" width="900" height="260"></canvas>
          </article>

          <article class="chart-card">
            <div class="chart-head">
              <p class="title">Solver Iteration Trace</p>
              <p class="sub">Operating-point fixed-point iterations (V3 and Vout)</p>
            </div>
            <canvas id="chartSolverTrace" width="900" height="260"></canvas>
          </article>

          <article class="chart-card">
            <div class="chart-head">
              <p class="title">Solver Residual per Iteration</p>
              <div class="chart-controls">
                <label for="residualScale">Scale</label>
                <select id="residualScale">
                  <option value="linear">Linear</option>
                  <option value="log">Log10</option>
                </select>
              </div>
            </div>
            <canvas id="chartSolverResidual" width="900" height="260"></canvas>
          </article>
        </section>

        <section class="panel docs" aria-label="Documentation panel">
          <h2>Model Notes</h2>
          <p>
            Capacitances are computed with ideal parallel-plate physics:
            <code>C = ε0·εr·A/d</code> where <code>A = width·height</code> and
            <code>dLeft = max(minGap, p·G)</code>, <code>dRight = max(minGap, (1-p)·G)</code>.
          </p>
          <p>
            Bidirectional switched-cap model:
            <code>Q_packet = 2·Vpeak·(Ca-Cb)</code>,
            then each cycle applies sensor injection on <code>C3</code>, bidirectional charge sharing between
            <code>C3</code> and <code>C4</code>, and output leakage via <code>R_eq</code>.
            Periodic steady-state is solved iteratively from <code>x[n+1]=F(x[n])</code>.
            Polarity is mapped so rightward motion is positive.
          </p>
          <p>
            Simplifications: front-end only (no U1A/integrator/coil loop), no fringing, no plate-thickness effects,
            and full-charge assumption kept with warning when half-cycle is below <code>5·max(τA, τB)</code>.
          </p>
        </section>
      </section>
    </section>
  </main>

  <script type="module" src="/src/app.js"></script>
</body>
</html>
